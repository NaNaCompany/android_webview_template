name: Build Custom Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Install Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        # yq is usually pre-installed on GitHub Actions runners (ubuntu-latest)

    - name: Parse Config
      id: config
      run: |
        # Simple parsing of yaml using grep and cut
        APP_NAME=$(grep "app_name:" config.yml | cut -d '"' -f 2)
        WEBVIEW_URL=$(grep "webview_url:" config.yml | cut -d '"' -f 2)
        
        echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
        echo "WEBVIEW_URL=$WEBVIEW_URL" >> $GITHUB_ENV
        
        echo "Parsed Configuration:"
        echo "App Name: $APP_NAME"
        echo "URL: $WEBVIEW_URL"

    - name: Apply Configuration (Strings)
      run: |
        cd android-webview-template/app/src/main/res/values
        
        # Escape special characters for sed if necessary (basic implementation)
        # Using | as delimiter
        sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$APP_NAME</string>|g" strings.xml
        sed -i "s|<string name=\"webview_url\">.*</string>|<string name=\"webview_url\">$WEBVIEW_URL</string>|g" strings.xml
        
        cat strings.xml

    - name: Generate Icons
      run: |
        # Helper function to resize and copy
        # We assume icon.png is in the root
        
        ICON_SRC="icon.png"
        RES_PATH="android-webview-template/app/src/main/res"
        
        if [ ! -f "$ICON_SRC" ]; then
            echo "Error: icon.png not found in root!"
            exit 1
        fi

        echo "Generating icons from $ICON_SRC..."
        
        # MDPI (48x48)
        mkdir -p $RES_PATH/mipmap-mdpi
        convert $ICON_SRC -resize 48x48 $RES_PATH/mipmap-mdpi/ic_launcher.png
        convert $ICON_SRC -resize 48x48 $RES_PATH/mipmap-mdpi/ic_launcher_round.png

        # HDPI (72x72)
        mkdir -p $RES_PATH/mipmap-hdpi
        convert $ICON_SRC -resize 72x72 $RES_PATH/mipmap-hdpi/ic_launcher.png
        convert $ICON_SRC -resize 72x72 $RES_PATH/mipmap-hdpi/ic_launcher_round.png

        # XHDPI (96x96)
        mkdir -p $RES_PATH/mipmap-xhdpi
        convert $ICON_SRC -resize 96x96 $RES_PATH/mipmap-xhdpi/ic_launcher.png
        convert $ICON_SRC -resize 96x96 $RES_PATH/mipmap-xhdpi/ic_launcher_round.png

        # XXHDPI (144x144)
        mkdir -p $RES_PATH/mipmap-xxhdpi
        convert $ICON_SRC -resize 144x144 $RES_PATH/mipmap-xxhdpi/ic_launcher.png
        convert $ICON_SRC -resize 144x144 $RES_PATH/mipmap-xxhdpi/ic_launcher_round.png

        # XXXHDPI (192x192)
        mkdir -p $RES_PATH/mipmap-xxxhdpi
        convert $ICON_SRC -resize 192x192 $RES_PATH/mipmap-xxxhdpi/ic_launcher.png
        convert $ICON_SRC -resize 192x192 $RES_PATH/mipmap-xxxhdpi/ic_launcher_round.png

        echo "Icon generation complete."

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: 8.2

    - name: Build with Gradle
      run: |
        cd android-webview-template
        chmod +x gradlew || true
        # Using gradle from environment if wrapper fails or isn't perfect
        gradle assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: android-webview-template/app/build/outputs/apk/debug/app-debug.apk
